# About

Ashtray is a custom and private `eopkg` repository. `eopkg` is the packaging format conceived and adopted by [Solus-Project](https://getsol.us), a Linux desktop distribution built from scratch.

This private repository was born by the need of having a place where to put custom packages which were not included by default on official repository (such as the Pantheon Desktop stack, left out from Solus-Project repository due to [legitimate reasons](https://discuss.getsol.us/d/1500-how-to-generate-custom-iso/12)).

# Installation

The enablement is done using the `eopkg` toolset:

``` bash
eopkg add-repo streambinder https://solus.davidepucci.it/eopkg-index.xml.xz
```

If getting a specific repository release is desired instead:

``` bash
tag="https://github.com/streambinder/ashtray/releases/download/v1"
eopkg add-repo streambinder "${tag}/eopkg-index.xml.xz
```

# Infrastructure

## Source code

The source code repository is including two kind of entities:

1.packages templates: these ones represent the instructions needed to the `eopkg` build tool to generate the corresponding installable package; 
2.build automation scripts: these are basically a collection of Bash/Python based snippets used to do concurrent and incremental build of packages as well to wrap them up to make them fit into a legal `eopkg` repository.

On the other hand, what is being generated by the combination of the ones above, the effective `eopkg` files are released relying on GitHub _Releases_ functionality, in a perfectly `eopkg` compliant structure.

### Building

The repository offers a `zeus` configuration, used to batch _do things_, such as running a common repository full build or a check for packages pending updates.

The build order is dictated by the `src/series` file: this is needed as several packages have build dependencies _inside_ the repository itself. Hence, the `series` file splits all the packages in several subsequent iteration groups, which assure that a specific `package-x` gets built and indexed on the local (in-build) repository before the depending `package-y` package.

Also, in order to make the whole process work, `solbuild` (the tool used to build the package starting from a `package.yml` template) needs to be configured to treat the local build directory as a local repository. This can be done by editing the `/usr/share/solbuild/main-x86_64.profile` settings and adding the following lines:

``` go
remove_repos = ["Solus"]
add_repos = ["Local", "Ashtray", "Solus"]

[repo.Local]
uri = "/path/to/ashtray/bin"
local = true
autoindex = true

[repo.Ashtray]
uri = "https://solus.davidepucci.it/eopkg-index.xml.xz"

[repo.Solus]
uri = "https://mirrors.rit.edu/solus/packages/shannon/eopkg-index.xml.xz"
```

## Hosting

The whole repository is hosted on GitHub: the packages templates and build instructions in the Git repository itself, while the built `eopkg` files and the indexes are kept in dedicated repository releases.

Sticking to a GitHub release only had few issues, though:

1. the repository URL was way too long and complicated to be easily remembered;
2. `eopkg` repository management does not support repository URL redirections: this means `github.com/.../releases/latest` could not be used as repository URL and that the only way to offer the repository without additional headaches was to create a single fixed release, which would have been filled with any package updates everytime it was needed.

These two issues led to the additional headache of configuring a custom web server which translates the requests made to `https://solus.davidepucci.it` to the latest GitHub repository release, by rewriting the request `Location` header. This gets done with this little PHP snippet:

``` php
<?php

if (strlen($_SERVER['REQUEST_URI']) == 0
        || strcmp($_SERVER['REQUEST_URI'], '/') == 0) {
    header("location: https://doc.davidepucci.it/p/ashtray");
    return;
}

$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, 'https://github.com/streambinder/ashtray/releases/latest');
curl_setopt($ch, CURLOPT_HEADER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_exec($ch);
$ch_url = curl_getinfo($ch, CURLINFO_EFFECTIVE_URL);
$ch_download_url = str_replace('/tag/', '/download/', $ch_url);
header("location: ".$ch_download_url.$_SERVER['REQUEST_URI']);

?>
```

This way, the `solus.davidepucci.it` host behaves as a poor and rough proxy, redirecting dynamically the requests without taking charge of the traffic generated by repository indexes and packages downloads.

Also, this `.htaccess` is used to forward all the files `GET` requests to the PHP snippet above:

``` 
RewriteEngine on
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^.*$ /index.php [L,QSA]
```

# Solbump

Solbump is a tool to automatically upgrade `eopkg` YAML-formatted source files to latest releases. Hence, the naming similarity with `solbuild` , the tool made from Solus project core team to build `eopkg` packages.

Based on the amount of defined (and pluggable) providers, it tries to recognize the format of the tarballs or archives defined as source files from the YAML file and find a matching provider. Then it's able to query for a more updated release and, if so, it fetches the asset, calculates the hashsum and update the original `package.yml` coherently.

## Usage

Before starting using the tool, further actions need to be taken, in order to access all its capabilities. In fact, few providers could be in the need of API tokens or specific configurations. So create the configuration file at `~/.config/solbump` and, depending on your needs, fill it with data you own:

``` yaml
# To obtain the token, go to:
# https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line#creating-a-token
# Solbump does not require any scope to be enabled.
github:
    api: habmfnlzrwmxuopmjganlqfpmccouxieijlouxcl

# To obtain the token, go to:
# https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html
# Solbump requires only the API access scope enablement.
gitlab:
    api: hmlhnbzndrogcifs-akb
```

Using the tool is pretty straightforward:

``` bash
solbump package1.yml package2/package.yml
```

## Installation

### Package manager

Installation from repositories is only available for Solus-Project users which have enabled [ `ashtray` ](./) repository:

``` bash
eopkg it -y solbump
```

### GO toolset

``` bash
go get github.com/streambinder/solbump
```

